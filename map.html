<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neural Memory Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at center, #0f111a, #000);
      overflow: hidden;
      font-family: Arial, sans-serif;
      color: white;
    }
    h2 {
      position: absolute;
      top: 15px;
      left: 20px;
      color: #00ffc3;
      font-size: 1.4rem;
      text-shadow: 0 0 10px #00ffc3;
    }
    svg {
      width: 100vw;
      height: 100vh;
    }
    .node circle {
      stroke: #00ffc3;
      stroke-width: 1px;
      fill: #0f111a;
    }
    .node text {
      fill: #fff;
      pointer-events: none;
      font-size: 12px;
    }
    .link {
      stroke: #333;
      stroke-opacity: 0.6;
    }
    #details {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 10px;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <h2>ðŸ§  Neural Memory Map</h2>
  <div id="details"></div>
  <svg></svg>
  <script>
    const API = "http://127.0.0.1:8000";
    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select("svg");
    const details = document.getElementById("details");

    async function fetchMemories() {
      const res = await fetch(`${API}/memories/`);
      const data = await res.json();
      return data;
    }

    function makeGraph(memories) {
      const nodes = memories.map(m => ({ id: m.id, title: m.title, tags: m.tags }));
      const links = [];

      nodes.forEach(a => {
        nodes.forEach(b => {
          if (a.id !== b.id && a.tags && b.tags && a.tags.split(',').some(t => b.tags.includes(t))) {
            links.push({ source: a.id, target: b.id });
          }
        });
      });

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(150))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g")
        .attr("stroke", "#444")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("class", "link");

      const node = svg.append("g")
        .attr("stroke", "#00ffc3")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class", "node")
        .call(drag(simulation));

      node.append("circle")
        .attr("r", 10)
        .on("click", (event, d) => showDetails(d));

      node.append("text")
        .attr("x", 15)
        .attr("y", 5)
        .text(d => d.title);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
      });
    }

    function drag(simulation) {
      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }
      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }
      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }

    async function showDetails(node) {
      const res = await fetch(`${API}/memories/${node.id}`);
      const data = await res.json();
      details.innerHTML = `<h3>${data.title}</h3><p>${data.content}</p><small>${data.tags}</small>`;
    }

    fetchMemories().then(makeGraph);
  </script>
</body>
</html>
